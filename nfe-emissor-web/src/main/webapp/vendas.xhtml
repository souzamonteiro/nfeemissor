<ui:composition template="template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://java.sun.com/jsf/facelets">

    <ui:define name="content">
        <div class="p-p-4">
            <h:form id="form">
                <p:growl id="growl" showDetail="true" life="3000" />
                
                <p:card>
                    <f:facet name="title">
                        <div class="p-d-flex p-ai-center p-jc-between">
                            <div>
                                <i class="pi pi-shopping-cart p-mr-2"></i>
                                <span class="form-title">Vendas e Emiss√£o de NF-e</span>
                            </div>
                            <p:commandButton value="Nova Venda" icon="pi pi-plus" 
                                           action="#{vendaController.novaVenda}" 
                                           update="form"
                                           rendered="#{!vendaController.editando}"/>
                        </div>
                    </f:facet>

                    <!-- Grid de Vendas -->
                    <p:outputPanel id="grid" rendered="#{!vendaController.editando}">
                        <p:dataTable id="vendasTable" var="venda" value="#{vendaController.vendas}" 
                                   paginator="true" rows="10" 
                                   emptyMessage="Nenhuma venda emitida">

                            <p:column headerText="N√∫mero NF-e" style="width: 100px;">
                                <h:outputText value="#{venda.numeroNfe}"/>
                            </p:column>

                            <p:column headerText="Cliente">
                                <h:outputText value="#{venda.clienteId.xnome}"/>
                            </p:column>

                            <p:column headerText="Data" style="width: 150px;">
                                <h:outputText value="#{venda.dataVenda}">
                                    <f:convertDateTime pattern="dd/MM/yyyy HH:mm"/>
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Valor Total" style="width: 120px;">
                                <h:outputText value="#{venda.valorTotal}">
                                    <f:convertNumber type="currency" currencyCode="BRL"/>
                                </h:outputText>
                            </p:column>
                            
                            <p:column headerText="PIX" style="width: 80px;">
                                <h:outputText value="‚úÖ" rendered="#{venda.chavePix != null}"/>
                                <h:outputText value="-" rendered="#{venda.chavePix == null}"/>
                            </p:column>
                            
                            <p:column headerText="Status" style="width: 100px;">
                                <p:tag value="#{venda.status}" 
                                     severity="#{venda.status == 'EMITIDA' ? 'success' : venda.status == 'PENDENTE' ? 'warning' : 'danger'}"/>
                            </p:column>

                            <p:column headerText="Chave NF-e" style="width: 200px;">
                                <h:outputText value="#{venda.chaveNfe}" 
                                            rendered="#{venda.chaveNfe != null}"/>
                                <h:outputText value="-" rendered="#{venda.chaveNfe == null}"/>
                            </p:column>
                        </p:dataTable>
                    </p:outputPanel>

                    <!-- Formul√°rio de Venda -->
                    <p:outputPanel id="formPanel" rendered="#{vendaController.editando}">
                        <p:panel header="Nova Venda" style="margin-bottom: 20px;">
                            <div class="p-fluid">
                                <div class="p-grid">
                                    <div class="p-col-12">
                                        <p:outputLabel for="cliente" value="Cliente"/>
                                        <!-- Na se√ß√£o do dropdown de cliente: -->
                                        <p:selectOneMenu id="cliente" 
                                                       value="#{vendaController.clienteSelecionado}" 
                                                       converter="clienteConverter"
                                                       required="true" 
                                                       requiredMessage="Selecione um cliente"
                                                       style="width: 100%">
                                            <f:selectItem itemLabel="Selecione um cliente" itemValue="#{null}"/>
                                            <f:selectItems value="#{vendaController.clientes}" var="cli" 
                                                          itemLabel="#{cli.xnome} - #{cli.documentoFormatado}" 
                                                         itemValue="#{cli}"/>
                                            <p:ajax update="@this" /> <!-- Adicionar para manter o estado -->
                                        </p:selectOneMenu>
                                    </div>
                                </div>

                                <p:panel header="Itens da Venda" style="margin: 20px 0;">
                                    <div class="p-grid">
                                        <div class="p-col-12 p-md-6">
                                            <p:outputLabel for="produto" value="Produto"/>
                                            <p:selectOneMenu id="produto" 
                                                           value="#{vendaController.produtoSelecionado}" 
                                                           converter="produtoConverter"
                                                           style="width: 100%">
                                                <f:selectItem itemLabel="Selecione um produto" itemValue="#{null}"/>
                                                <f:selectItems value="#{vendaController.produtos}" var="prod" 
                                                             itemLabel="#{prod.xprod} - R$ #{prod.vuncom}" 
                                                             itemValue="#{prod}"/>
                                            </p:selectOneMenu>
                                        </div>

                                        <div class="p-col-12 p-md-4">
                                            <p:outputLabel for="quantidade" value="Quantidade"/>
                                            <p:inputNumber id="quantidade" 
                                                         value="#{vendaController.itemVenda.quantidade}" 
                                                         minValue="0.001" 
                                                         decimalPlaces="3"
                                                         style="width: 100%"/>
                                        </div>

                                        <div class="p-col-12 p-md-2" style="display: flex; align-items: flex-end;">
                                            <p:commandButton value="Adicionar" icon="pi pi-plus" 
                                                           action="#{vendaController.adicionarItem}"
                                                           style="width: 100%;"
                                                           update="vendaItens @form"/>
                                        </div>
                                    </div>

                                    <p:dataTable id="vendaItens" var="item" 
                                                value="#{vendaController.venda.itemVendaCollection}" 
                                                emptyMessage="Nenhum item adicionado" 
                                                style="margin-top: 20px;">

                                        <p:column headerText="Produto">
                                            <h:outputText value="#{item.produtoId.xprod}"/>
                                        </p:column>

                                        <p:column headerText="Quantidade" style="width: 100px;">
                                            <h:outputText value="#{item.quantidade}">
                                                <f:convertNumber pattern="0.###"/>
                                            </h:outputText>
                                        </p:column>

                                        <p:column headerText="Valor Unit√°rio" style="width: 120px;">
                                            <h:outputText value="#{item.valorUnitario}">
                                                <f:convertNumber type="currency" currencyCode="BRL"/>
                                            </h:outputText>
                                        </p:column>

                                        <p:column headerText="Valor Total" style="width: 120px;">
                                            <h:outputText value="#{item.valorTotal}">
                                                <f:convertNumber type="currency" currencyCode="BRL"/>
                                            </h:outputText>
                                        </p:column>

                                        <p:column headerText="A√ß√µes" style="width: 80px;">
                                            <p:commandButton icon="pi pi-trash" title="Remover" 
                                                           action="#{vendaController.removerItem(item)}"
                                                           update="vendaItens @form"/>
                                        </p:column>
                                    </p:dataTable>

                                    <div class="p-d-flex p-jc-end p-mt-3">
                                        <h:outputText value="Total: " style="font-weight: bold; margin-right: 10px;"/>
                                        <h:outputText value="#{vendaController.venda.valorTotal}" 
                                                    style="font-weight: bold; font-size: 1.2rem;">
                                            <f:convertNumber type="currency" currencyCode="BRL"/>
                                        </h:outputText>
                                    </div>
                                </p:panel>

                                <div class="p-d-flex p-jc-end p-mt-3">
                                    <p:commandButton value="Finalizar Venda e Emitir NF-e" 
                                                   icon="pi pi-check" 
                                                   action="#{vendaController.finalizarVenda}"
                                                   style="background: #4CAF50; border: none;"
                                                   update="@form"/>
                                    <p:commandButton value="Cancelar" 
                                                   icon="pi pi-times" 
                                                   action="#{vendaController.cancelarVenda}"
                                                   style="margin-left: 5px;"
                                                   update="@form"/>
                                </div>
                            </div>
                        </p:panel>
                    </p:outputPanel>
                </p:card>
                
                <p:dialog id="pdfDialog" header="NF-e Emitida" widgetVar="pdfDialog" 
                          modal="true" width="500" height="auto" dynamic="false" 
                          onShow="updateQrCode();">

                    <div style="padding: 20px;">
                        <div class="p-mb-3" style="text-align: center;">
                            <h4>NF-e Emitida com Sucesso!</h4>
                        </div>

                        <div class="p-fluid p-mb-3">
                            <div class="p-field">
                                <label>N√∫mero NF-e:</label>
                                <p:outputLabel value="#{vendaController.venda.numeroNfe}" 
                                             style="font-weight: bold;"
                                             id="numeroNfeLabel"/>
                            </div>

                            <div class="p-field">
                                <label>Chave de Acesso:</label>
                                <p:outputLabel value="#{vendaController.venda.chaveNfe}" 
                                             style="font-size: 10px; word-break: break-all; color: #666;"
                                             id="chaveNfeLabel"/>
                            </div>

                            <!-- Se√ß√£o PIX - somente se houver chave PIX -->
                            <div class="p-field" id="pixSection"
                                 rendered="#{vendaController.venda.chavePix != null and not empty vendaController.venda.chavePix}">

                                <!-- QR Code -->
                                <!--
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <p:graphicImage id="qrCodeImage"
                                                  value="#{vendaController.qrCodePixBase64}"
                                                  alt="QR Code PIX"
                                                  style="border: 1px solid #ddd; padding: 5px; width: 250px; height: 250px;"/>
                                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                                        Escaneie o QR Code com seu app banc√°rio
                                    </p>
                                </div>
                                -->

                                <label>PIX Copia e Cola:</label>
                                <div style="position: relative;">
                                    <p:inputTextarea id="chavePix" 
                                                   value="#{vendaController.venda.chavePix}" 
                                                   rows="4" 
                                                   style="width: 100%; font-family: monospace; font-size: 11px;"
                                                   readonly="true"/>
                                    <p:commandButton icon="pi pi-copy" 
                                                   title="Copiar PIX"
                                                   style="position: absolute; right: 5px; top: 5px;"
                                                   onclick="copyPixToClipboard(); return false;"/>
                                </div>
                                <small style="color: #666;">Clique no bot√£o copiar para colar no seu aplicativo banc√°rio</small>
                            </div>
                        </div>

                        <div class="p-d-flex p-jc-between p-mt-4">
                            <!-- Bot√£o para abrir PDF -->
                            <p:commandButton value="üìÑ Abrir DANFE" 
                                           action="#{vendaController.abrirPDF}"
                                           styleClass="ui-button-primary"
                                           oncomplete="PF('pdfDialog').hide();" />

                            <!-- Link para download PDF -->
                            <a href="#{request.contextPath}/pdf/download?chave=#{vendaController.venda.chaveNfe}" 
                               target="_blank" 
                               class="ui-button ui-button-success"
                               style="text-decoration: none; padding: 0.5em 1em; border-radius: 4px;"
                               onclick="PF('pdfDialog').hide();">
                               ‚¨áÔ∏è Baixar DANFE
                            </a>

                            <p:commandButton value="Fechar" 
                                           onclick="PF('pdfDialog').hide();"/>
                        </div>
                    </div>

                    <!-- Script para copiar PIX -->
                    <h:outputScript>
                        function copyPixToClipboard() {
                            var pixText = document.getElementById('form:chavePix').value;
                            navigator.clipboard.writeText(pixText).then(function() {
                                PrimeFaces.showMessage({
                                    severity: 'info',
                                    summary: 'Copiado',
                                    detail: 'Chave PIX copiada para a √°rea de transfer√™ncia'
                                });
                            }).catch(function(err) {
                                console.error('Erro ao copiar: ', err);
                            });
                        }

                        function updateQrCode() {
                            // Atualiza a imagem do QR Code quando o di√°logo abre
                            var qrCodeImg = document.getElementById('form:qrCodeImage');
                            if (qrCodeImg) {
                                // For√ßa o reload da imagem
                                var src = qrCodeImg.src;
                                qrCodeImg.src = '';
                                qrCodeImg.src = src;
                            }
                        }
                    </h:outputScript>
                </p:dialog>
            </h:form>
        </div>
    </ui:define>
</ui:composition>